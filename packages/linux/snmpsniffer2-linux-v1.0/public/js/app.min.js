var socket;$(document).ready(function(){function t(t){t?($.each(t,function(t,o){$("[name="+t+"]","#dialog_form").val(o)}),$("#dialog_form > input[type='checkbox']").prop("checked",function(){return t[$(this).attr("name")]})):($("#dialog_form > #id").val("0"),$("#dialog_form > input[type='checkbox']").prop("checked",!0))}function o(){return socket.emit("close_window"),null}function e(t,o){($(t).width()>o||$(t).width()<o)&&$(t).width(o)}function i(t,o){var e=o?o:{};return $(t).serialize().split("&").forEach(function(t){var o=t.split("=");o.length>=2&&(e[o[0]]=decodeURIComponent(o[1]).replace(/\+/g,""))}),e}function n(t){t?($("#show_options").text("Show Options"),$("#pcap_options").hide()):($("#show_options").text("Hide Options"),$("#pcap_options").show())}function a(t){$(t).find("li").remove()}function s(t,o,e,i){function n(n){if(o&&o.length>0){var a=$("<li></li>").text(n);e&&$(a).addClass(e),$(t).append(a),i&&$(a).hide()}}o&&(_(o).isArray()?_(o).each(function(t){n(t.toString())}):n(o.toString()))}function p(t){var o=t.packet;if(o){var e=o.timestamp+" "+o.version+" "+o.ip+" "+o.command+" id="+o.reqid,i=_(o.oids).map(function(t){return t.oid+(t.type?" "+t.type+"="+t.data:"")}).join(", ");_(o.oids).size()>1&&(i=" [ "+i+" ] "),e+=i,"0"!==o.status&&(e+="error: "+o.status);var n="Response"===o.command?"res":"req";s($("#pcap_output"),e,n,t.responses_only&&"Response"!==o.command)}}function c(t){$("#options_message").text(t?"Options are not editable while running the sniffer":""),$("#interface, #add_option, #remove_all, .remove-option, .edit-option, .src,.dst").prop("disabled",t),$("#filename").prop("disabled",t),$("#buffer").prop("disabled",t),$("#pcap_clear").prop("disabled",t),$("#responses_only").prop("disabled",t)}function l(t){s($("#snmp_output"),t.input),s($("#snmp_output"),t.output?t.output.split("\n"):""),s($("#snmp_output"),t.error),d++,d>=t.count&&socket.emit("snmp_stop")}socket=io.connect("/",{"reconnection delay":9e5}),window.chrome||$("#exit").hide(),window.App={Models:{},Collections:{},Views:{}};var r={ip:null,src:!1,dst:!1,port:null,ports:[]},d=0;App.Models.Opt=Backbone.Model.extend({defaults:r,set:function(t){return t.port&&(t.ports=_.chain(t.port.split(",")).map(function(t){return t.trim()}).compact().value()),Backbone.Model.prototype.set.apply(this,arguments)},validate:function(t,o){if(_.chain(o).omit("validate","collection").isEmpty().value()){if(!(t.ip&&0!=t.ip.length||t.port&&0!=t.port.length))return"You have to specify either ip or port";if(!t.src&&!t.dst)return"This data needs to be either source or destination";if(o.collection&&this.collection.contains(t))return"The ip and port(s) are already on the list"}},edit:function(t){this.save(t)}}),App.Collections.Opts=Backbone.Collection.extend({model:App.Models.Opt,localStorage:new Backbone.LocalStorage("options-backbone"),contains:function(t){return this.some(function(o){var e=o.get("ports");return o.get("ip")===t.ip&&(_(e).isEmpty()||e.some(function(o){var e=new RegExp("(,s*)?"+o+"(s*,)?");return t.port.match(e)}))})}}),App.Views.OptionView=Backbone.View.extend({tagName:"li",template:_.template($("#option_template").html()),initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"remove",this.remove)},events:{"click .remove-option":"removeOpt","click .edit-option":"showDialog","click .src,.dst":"toggleCheckbox"},showDialog:function(){t(this.model.attributes),$("#add_dialog").dialog("open")},removeOpt:function(){confirm("Are you sure, you want to remove this option?")&&this.model.destroy()},toggleCheckbox:function(t){t.preventDefault();var o=$(t.currentTarget),e={};e[$(o).attr("name")]=$(o).is(":checked"),this.model.save(e,{validate:!0})},render:function(t,o){return!o||o.validate?(this.$el.html(this.template(this.model.toJSON())),this.$el.find("span.ui-icon").tooltip(),this):void 0},remove:function(){this.$el.remove()}}),App.Views.AppView=Backbone.View.extend({el:$("#option_field"),initialize:function(){this.opts=new App.Collections.Opts(null,{view:this}),this.opts.on("invalid",function(t,o){alert(o)}),this.listenTo(this.opts,"add",this.addLi),this.opts.fetch(),this.render()},events:{"click #add_option":"showDialog"},showDialog:function(){t(),$("#add_dialog").dialog("open")},addModel:function(t){return this.opts.create(t,{validate:!0})},addLi:function(t){var o=new App.Views.OptionView({model:t});this.$el.find("#option_list").append(o.render().el)},setModel:function(t,o){return this.opts.get(t).save(o,{validate:!0})}});var u=new App.Views.AppView;window.onbeforeunload=o,$("#exit").on("click",function(){window.open(location,"_self").close()}),$("#dialog_form > input[type='checkbox']").on("click",function(){$(this).val($(this).is(":checked"))}),$("#option_list > li > input[type='checkbox']").on("click",function(t){t.preventDefault()}),$("#option_field > button").tooltip();var f=$("#content").width()/2;$("#option_list").resizable({maxWidth:Math.max($("#content").width()/5,500)}),$("#commands").resizable({maxWidth:Math.max(f,800)}),$("#pcap_output").resizable({maxWidth:Math.max(f,600)}),$("#snmp_output").resizable({maxWidth:Math.max(f,800)}),e($("#commands"),Math.min(f,800)),e($("#snmp_output"),Math.min(f,800)),e($("#pcap_output"),Math.min(4*f/5,600)),e($("#option_list"),Math.min($("#content").width()/5,500)),$("#log").dialog({modal:!0,buttons:{Ok:function(){$(this).dialog("close")}}}),$("#log").keypress(function(t){return $(this).dialog("isOpen")&&t.keyCode==$.ui.keyCode.ENTER?($(this).parent().find("button:eq(1)").trigger("click"),!1):void 0}),$("#show_log").on("click",function(){$("#log").dialog("open")}),$("#add_dialog").dialog({autoOpen:!1,modal:!0,width:460,buttons:[{text:"Submit",click:function(t){var t=t||window.event;"undefined"!=typeof t.stopPropagation?t.stopPropagation():t.cancelBubble=!0,t.preventDefault();var o,e=_.clone(r);i($("#dialog_form"),e);var n=e.id;o="0"==n?u.addModel(_.omit(e,"id")):u.setModel(n,e),o&&!o.validationError&&$(this).dialog("close")}},{text:"Cancel",click:function(){$(this).dialog("close")}}],create:function(){$("#add_dialog").keypress(function(t){return $(this).dialog("isOpen")&&t.keyCode==$.ui.keyCode.ENTER?($(this).parent().find("button:eq(1)").trigger("click"),!1):void 0})},close:function(){$("#add_option").blur()}}),$("#remove_all").on("click",function(){$("#remove_all").blur(),u.opts.length>0&&confirm("Are you sure, you want to remove all items?")&&(u.opts.each(function(t){t&&t.destroy()}),u.opts.reset())}),n(0==u.opts.length),$("#show_options").on("click",function(){n($("#pcap_options").is(":visible"))}),$("#pcap_clear").on("click",function(){$("#pcap_output").html().length>0&&confirm("Are you sure?")&&a($("#pcap_output"))}),$("#snmp_clear").on("click",function(){$("#snmp_output").html().length>0&&confirm("Are you sure?")&&a($("#snmp_output"))}),$("#start_pcap").on("click",function(){if("Stop"==$(this).val())socket.emit("pcap_stop");else{a($("#pcap_output"));var t=u.opts.toJSON();socket.emit("pcap_start",{inter:$("#interface").val(),filename:$("#filename").val(),bufferMult:$("#buffer").val(),options:t,responses_only:$("#responses_only").is(":checked")})}}),$("#responses_only").on("change",function(){$(this).is(":checked")?$("#pcap_output > li.req").hide():$("#pcap_output > li.req").show()}),socket.on("pcap_start",function(){$("#start_pcap").val("Stop"),c(!0),$("#pcap_status > b").text("Package sniffing on")}),socket.on("pcap_file_overwrite",function(t){var o=t.data;confirm("The file already exists, overwrite it?")?o.newfilename=t.newfilename:($("#filename").val(""),o.newfilename=null),o.checked=!0,socket.emit("pcap_start",o)}),socket.on("pcap_track",function(t){p(t)}),socket.on("pcap_stop",function(){$("#start_pcap").val("Start"),c(!1),$("#pcap_status > b").text("Package sniffing off")}),$("#run_snmp").on("click",function(){if("Cancel"==$(this).val())socket.emit("snmp_stop");else{var t=_($("#snmp_commands").val().split(";")).compact();!t||_(t).isEmpty()?alert("No commands provided"):($(this).val("Cancel"),$("#snmp_loading").show(),a($("#snmp_output")),d=0,socket.emit("snmp_start",{data:t,bufferMult:$("#buffer").val()}))}}),socket.on("snmp_track",function(t){l(t)}),socket.on("snmp_stop",function(){$("#snmp_loading").hide(),$("#run_snmp").val("Run SNMP")}),socket.on("app_error",function(t){console.log("app error"),alert(t)}),socket.on("error",function(t){alert(t.toString())})});