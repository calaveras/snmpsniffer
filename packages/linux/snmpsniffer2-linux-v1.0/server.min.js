#!/usr/bin/env node
function createDir(e){if(e&&e.length>0&&!fs.existsSync(e)){var r=_(e.split(path.sep)).compact(),t=e.charAt(0)===path.sep?path.sep:"";try{_(r).each(function(e){t+=(t.length>0?path.sep:"")+e,fs.existsSync(t)||fs.mkdirSync(t)})}catch(n){throw logger.error(n.message),n}}}function getUserHome(){return process.env.HOME||process.env.HOMEPATH||process.env.USERPROFILE}function getUserFile(e,r){if(r&&r.length>0){if("Windows_NT"==ostype&&r.split(path.sep)[0].match(/^[A-Z]:\\/i)||"/"==r.charAt(0))return r;var t=e?path.join(getUserHome(),e):path.join(getUserHome(),PCAP_DIR);return createDir(t),path.join(t,r)}return null}function getLogFile(e){if("console"===e)return"console";var r=getUserFile(LOG_DIR,e);if("Linux"==ostype||"Darwin"==ostype){fs.existsSync(r)||fs.writeFileSync(r,"");try{fs.chmodSync(r,511)}catch(t){}}return r}function decode(e){try{var r=reHex.test(e)?Hex.decode(e):Base64.unarmor(e);return ASN1.decode(r)}catch(t){return t.message}}function decoded_data(e){var r=e.typeName().replace(/_/g," "),t={head:r},n=e.content();if(null!==n&&(n=String(n),t.value=n,t.tag=e.tag),null!==e.sub){t.sub=[];for(var o=0,s=e.sub.length;s>o;++o)t.sub.push(decoded_data(e.sub[o]))}return t}function decoded_pdu(e){function r(e){if(e){if(!_(e).isArray())return e.tag&&e.tag.command?e:r(e.sub);for(var t=0;t<e.length;t++){var n=r(e[t]);if(null!=n)return n}}return null}var t={},n=decoded_data(e);if("SEQUENCE"===n.head.trim()){var o=n.sub;if(o&&o.length>=3){var s=o[0];if("INTEGER"===s.head.trim()){var i,a,c,p=[];switch(s.value){case"0":i="v1";break;case"1":i="v2c";break;case"3":i="v3";break;default:i="uknown snmp version"}var u=r(o.slice(1));if(u&&u.sub&&u.sub.length>=3){a=u.tag.command;var l=u.sub;"INTEGER"===l[0].head.trim()&&(reqid=l[0].value),"INTEGER"===l[1].head.trim()&&(c=l[1].value);for(var d=3;0===p.length&&d<l.length;){if("SEQUENCE"===l[d].head.trim()&&l[d].sub&&l[d].sub.length>0){var f=l[d].sub;f.forEach(function(e){if("SEQUENCE"===e.head.trim()&&e.sub&&e.sub.length>0){var r=e.sub;if("OBJECT IDENTIFIER"===r[0].head.trim()){var t={oid:r[0].value};r[1]&&"NULL"!==r[1].head&&(t.type=r[1].head,t.data=r[1].value),p.push(t)}}})}d++}p.length>0&&(t.version=i,t.command=a,t.reqid=reqid,t.oids=p,t.status=c)}}}}return t}function writeheader(){writer&&(_(header).each(function(e,r){r>0&&writer.write("	"),writer.write(e)}),writer.write("\n"))}function setWriter(e){if(e)try{var r=path.dirname(e);createDir(r),writer=fs.createWriteStream(e),writer.on("error",function(e){throw logger.error("error writing to file: "+e),e}).on("finish",function(){logger.info("writing to file finished")}),writeheader()}catch(t){throw logger.error("error setting up file: "+t.message),t}else writer=null}function write(e){function r(e,r){writer.write((e?e:"")+(r?"\n":"	"))}function t(t,n){r(e[t],n)}if(writer){var n=e.oids;_(n).each(function(n){t("timestamp"),t("ip"),t("command"),t("reqid");var o=e.status+("0"===e.status?"(Success)":"(Error)");r(o),r(n.type),r(n.oid),r(n.data,!0)})}}function socketConnect(e){function r(e){return!!e&&fs.existsSync(e)}function t(e,r,t){var n="";if(e.length>0){var o=r.length>0?r:" ";n+=_.map(e,function(e){return t.push(e),o+(e.match(PORTRange)?" portrange ":" port ")+e}).join(" and ")}else n+=" port "+c,t.push(c);return n}function n(e,r){var n="";return _(e).isEmpty()?(n+=" port "+c,r.push(c)):n+=_.map(e,function(e){var n="";"true"==e.src&&"true"!=e.dst?n=" src ":"true"==e.dst&&"true"!=e.src&&(n=" dst ");var o="";e.ip.length>0&&(o=(n.length>0?n:e.ip.match(IP4CIDRRegex)?" net ":" host ")+e.ip);var s=t(e.ports,n,r);return o.length>0&&s.length>0&&(s=" and ( "+s+" ) "),o+s}).join(" or "),n}logger.info("client socket "+e.id+" connected");var o,s=null,i=!1,a=!1,c=161;e.on("pcap_start",function(t){var i=getUserFile(PCAP_DATA_DIR,t.filename);if(!t.checked&&r(i))e.emit("pcap_file_overwrite",{data:t,newfilename:i});else{i=t.newfilename||i,a=t.responses_only,o=(new Date).getTime();var c=(t.options,[]),p="udp and "+n(t.options,c);try{s=pcap.createSession(t.inter,p,pcapBufferSize*t.bufferMult),logger.info("starting sniffing..."),e.emit("pcap_start"),setWriter(i),s.on("packet",function(r){try{if(s.opened){var t=pcap.decode.packet(r),n=t.pcap_header,i=Math.round(100*(1e3*n.tv_sec+n.tv_usec/1e3-o))/100,c=decode(t.payload.payload.payload.data.toString("hex")),p=decoded_pdu(c);p.oids&&p.oids.length>0&&(p.timestamp=i,p.ip="Response"===p.command?_(t.payload.payload.saddr).values().join("."):_(t.payload.payload.daddr).values().join("."),write(p),e.emit("pcap_track",{packet:p,responses_only:a}))}}catch(u){logger.error("packet capture error: "+u.message)}})}catch(u){logger.error(u);var l=u.toString();0==l.indexOf("socket:")&&(l+=". You need to run the program as an administrator."),e.emit("app_error",l)}}}),e.on("pcap_stop",function(){s&&s.removeAllListeners("packet"),writer&&writer.end(),logger.info("stopping sniffing..."),e.emit("pcap_stop")}),e.on("snmp_start",function(r){var t=r.data,n=r.bufferMult;_(t).isArray()?(i=!0,logger.info("SNMP run started..."),_(t).each(function(r){if(i)try{snmp_process=exec(r,{maxBuffer:n*snmpBufferSize}),snmp_process.stdout.on("data",function(n){e.emit("snmp_track",{count:t.length,input:r,output:n})}),snmp_process.stderr.on("data",function(n){logger.error("exec error: "+n),e.emit("app_error",n),e.emit("snmp_track",{count:t.length,input:r,error:n})}),snmp_process.on("close",function(e){logger.info("closing the process with code: "+e)})}catch(o){console.log("error"),logger.error(o.message)}})):e.emit("snmp_stop")}),e.on("snmp_stop",function(){if(snmp_process){var r=/^win/.test(process.platform);r?exec("taskkill /PID "+snmp_process.pid+" /T /F",function(e){null!==e&&console.log("kill error: "+e)}):kill(snmp_process.pid)}kill(snmp_process.pid),i=!1,e.emit("snmp_stop")}),e.on("disconnect",function(){logger.info("disconnected")}),e.on("close_window",function(){logger.info("closing window"),1==_(io.sockets.connected).size()&&process.exit()})}var fs=require("fs"),path=require("path"),os=require("os"),connect=require("connect"),express=require("express"),bodyParser=require("body-parser"),_=require("underscore"),preprocessor=require("./preprocess.min.js"),child_process=require("child_process"),exec=child_process.exec,spawn=child_process.spawn,child,snmp_process,pcap_process,psTree=require("ps-tree"),pcap=require("pcap"),util=require("util"),Hex=require("./hex.min.js"),Base64=require("./base64.min.js"),ASN1=require("./asn1.min.js"),log4js=require("log4js"),PORT=process.env.PORT||5e3,IP4Regex=new RegExp("^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5]).){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$"),IP4CIDRRegex=new RegExp("^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5]).){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(/(d|[1-2]d|3[0-2]))$"),PORTRange=new RegExp("^d+s*-+s*d+$"),reHex=/^\s*(?:[0-9A-Fa-f][0-9A-Fa-f]\s*)+$/,writer=null,ostype=os.type(),pcapBufferSize=10485760,snmpBufferSize=204800,PCAP_DIR=".snmpsniffer",PCAP_DATA_DIR=".snmpsniffer_data",LOG_DIR=path.join(PCAP_DIR,"log"),psTree=require("ps-tree"),kill=function(e,r,t){r=r||"SIGKILL",t=t||function(){};var n=!0;if(n)psTree(e,function(n,o){[e].concat(o.map(function(e){return e.PID})).forEach(function(e){try{process.kill(e,r)}catch(t){}}),t()});else{try{process.kill(e,r)}catch(o){}t()}},header=["Time","Session","Type","RequestId","Status","Syntax","OID","Value"],app=express(),http=require("http"),server=http.createServer(app);preprocessor.preprocess(PORT);var logger;LOG_FILE&&"console"===LOG_FILE.trim()?logger=log4js.getLogger():(log4js.configure({appenders:[{type:"file",filename:getLogFile(LOG_FILE||"server.log"),category:"snmpsniffer",maxLogSize:20480,backups:10}]}),logger=log4js.getLogger("snmpsniffer"));var io=require("socket.io")(server,{closeTimeout:9e5,heartbeatTimeout:9e5,heartbeatInterval:6e5});require("jade"),app.set("view engine","jade"),app.locals.layout=!1,app.use(bodyParser.urlencoded({extended:!0})),app.use(bodyParser.json()),app.locals._=require("underscore"),app.use(express.static(__dirname+"/icons")),app.use(express.static(__dirname+"/public/css")),app.use(express.static(__dirname+"/public/js")),app.use(express.static(__dirname+"/node_modules/socket.io/node_modules/socket.io-client")),app.get("/",function(e,r){var t=require("os").networkInterfaces(),n=getUserHome()+("Windows_NT"==ostype?"\\":"/"+PCAP_DATA_DIR);r.render("index",{interfaces:t,home:n})});try{server.listen(PORT)}catch(err){logger.fatal(err.message),process.exit(1)}logger.info("Server running at port "+PORT),BROWSER&&(child=exec(BROWSER,function(e){null!==e&&(console.log("This application requires either Google Chrome or Firefox. If they are installed, please, run the application in the command line as 'snmpsniffer --no-browser' and then point your browser to http://localhost:"+PORT+" . Otherwise, install either Google Chrome or Firefox.\n"),logger.fatal("This application requires either Google Chrome or Firefox. Exec error: "+e),process.exit(1))})),io.sockets.on("connection",socketConnect),process.on("exit",function(e){writer&&writer.end(),console.log("About to exit with code:",e)});